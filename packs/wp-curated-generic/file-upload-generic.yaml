rules:
- id: wordpress.file.upload.missing-validation-generic
  languages: [php]
  message: |
    File uploaded without MIME/type/content checks before move. 
    
    REMEDIATION: Use WordPress built-in handlers or implement proper validation:
    1. Use wp_handle_upload() for media uploads (handles validation internally)
    2. For custom uploads, validate MIME type via finfo_file() or wp_checkfiletype_and_ext()
    3. Sanitize filename with sanitize_file_name()
    4. Store under wp_upload_dir()['path'] with wp_unique_filename()
    5. Implement file size limits and user capability checks
  severity: ERROR
  metadata:
    category: file_upload
    cwe: CWE-434
    vuln_class: file_upload
    confidence: medium
    tags: [file-upload, wordpress]
  patterns:
  # Constrain $TMP to only real upload sources to reduce false positives
  - pattern-either:
    - pattern: |
        move_uploaded_file($_FILES[$X]['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($f['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($file['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($FILE['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($upload['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($UPLOAD['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($FILES['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($F['tmp_name'], $DEST);
  
  # Essential suppressions for patterns not covered by structured blocks
  - pattern-not-regex: '(?i)wp_checkfiletype_and_ext\s*\('
  - pattern-not-regex: '(?i)wp_checkfiletype\s*\('
  - pattern-not-regex: '(?i)wp_handle_upload\s*\('
  
  # WordPress Media Handler Suppressions
  # These functions handle file validation internally and are safe by design
  - pattern-not-regex: '(?i)media_handle_upload\s*\('
  - pattern-not-regex: '(?i)wp_handle_sideload\s*\('

  # Combined MIME/content validation suppressions using pattern-either
  - pattern-not:
      pattern-either:
        - pattern-inside: |
            function $FUNC(...) {
              ...
              $FINFO = finfo_open(...);
              ...
              $MIME = finfo_file(...);
              ...
              move_uploaded_file($TMP, $DEST);
              ...
            }
        - pattern-inside: |
            function $FUNC(...) {
              ...
              $T = exif_imagetype(...);
              ...
              move_uploaded_file($TMP, $DEST);
              ...
            }
        - pattern-inside: |
            function $FUNC(...) {
              ...
              $SIZE = getimagesize(...);
              ...
              move_uploaded_file($TMP, $DEST);
              ...
            }

  # Combined WordPress upload flow suppressions using pattern-either
  - pattern-not:
      pattern-either:
        - pattern-inside: |
            function $FUNC(...) {
              ...
              $UP = wp_upload_dir(...);
              ...
              $SAFE = sanitize_file_name(...);
              ...
              $UNIQ = wp_unique_filename(...);
              ...
              move_uploaded_file($TMP, $DEST);
              ...
            }
        - pattern-inside: |
            function $FUNC(...) {
              ...
              if ( current_user_can('upload_files') ) { ... move_uploaded_file($TMP, $DEST); ... }
              ...
            }
        - pattern-inside: |
            function $FUNC(...) {
              ...
              if ($F['size'] > wp_max_upload_size()) { ... }
              ...
              move_uploaded_file($TMP, $DEST);
              ...
            }

  # Suppress quarantine-first flows (tmp then async scan/rename) in same function
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          $Q = sys_get_temp_dir() . $ANY;
          ...
          move_uploaded_file($TMP, $Q);
          ...
        }

  # Suppress when an explicit scan function gates the move operation in same function
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          if (!$SCAN($TMP)) { ... }
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  # Suppress when move_uploaded_file is locally stubbed in test functions
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          if (!function_exists('move_uploaded_file')) {
            function move_uploaded_file(...) { ... }
          }
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }


