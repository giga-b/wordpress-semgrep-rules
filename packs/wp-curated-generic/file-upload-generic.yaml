rules:
- id: wordpress.file.upload.missing-validation-generic
  languages: [php]
  message: File uploaded without MIME/type/content checks before move.
  severity: ERROR
  metadata:
    category: file_upload
    cwe: CWE-434
    vuln_class: file_upload
    confidence: medium
    tags: [file-upload, wordpress]
  patterns:
  # Constrain $TMP to only real upload sources to reduce false positives
  - pattern-either:
    - pattern: |
        move_uploaded_file($_FILES[$X]['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($f['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($file['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($FILE['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($upload['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($UPLOAD['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($FILES['tmp_name'], $DEST);
    - pattern: |
        move_uploaded_file($F['tmp_name'], $DEST);
  # Essential suppressions for patterns not covered by structured blocks
  - pattern-not-regex: '(?i)wp_check_filetype_and_ext\s*\('
  - pattern-not-regex: '(?i)wp_check_filetype\s*\('
  - pattern-not-regex: '(?i)wp_handle_upload\s*\('

  # Suppress when robust MIME/content checks exist in the same function before move
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          $FINFO = finfo_open(...);
          ...
          $MIME = finfo_file(...);
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          $T = exif_imagetype(...);
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          $SIZE = getimagesize(...);
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  # Suppress when canonical WP upload flow or safeguards are used in the same function
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          $UP = wp_upload_dir(...);
          ...
          $SAFE = sanitize_file_name(...);
          ...
          $UNIQ = wp_unique_filename(...);
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          if ( current_user_can('upload_files') ) { ... move_uploaded_file($TMP, $DEST); ... }
          ...
        }

  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          if ($F['size'] > wp_max_upload_size()) { ... }
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  # Suppress quarantine-first flows (tmp then async scan/rename) in same function
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          $Q = sys_get_temp_dir() . $ANY;
          ...
          move_uploaded_file($TMP, $Q);
          ...
        }

  # Suppress when an explicit scan function gates the move operation in same function
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          if (!$SCAN($TMP)) { ... }
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  # Suppress when move_uploaded_file is locally stubbed in test functions
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          if (!function_exists('move_uploaded_file')) {
            function move_uploaded_file(...) { ... }
          }
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  # Suppress when canonical WordPress handlers are used in same function (these handle validation internally)
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          $ATTACHMENT_ID = media_handle_upload(...);
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          $ATTACHMENT_ID = wp_handle_sideload(...);
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  # Suppress when files are handled via WordPress media functions in same function (these are safe by design)
  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          if (media_handle_upload(...)) { ... }
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }

  - pattern-not:
      pattern-inside: |
        function $FUNC(...) {
          ...
          if (wp_handle_sideload(...)) { ... }
          ...
          move_uploaded_file($TMP, $DEST);
          ...
        }


