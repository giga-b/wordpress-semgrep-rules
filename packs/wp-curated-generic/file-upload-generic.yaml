rules:
- id: wordpress.file.upload.missing-validation-generic
  languages: [php]
  message: File uploaded without MIME/type/content checks before move.
  severity: ERROR
  metadata:
    category: file_upload
    cwe: CWE-434
    vuln_class: file_upload
    confidence: medium
    tags: [file-upload, wordpress]
  patterns:
  - pattern: |
      move_uploaded_file($TMP, $DEST);
  # Allow if common validation or quarantine/scan appears nearby in file
  - pattern-not-regex: '(?i)wp_check_filetype_and_ext\s*\('
  - pattern-not-regex: '(?i)wp_check_filetype\s*\('
  - pattern-not-regex: '(?i)mime_content_type\s*\('
  - pattern-not-regex: '(?i)finfo_(open|buffer|file)\s*\('
  - pattern-not-regex: '(?i)getimagesize\s*\('
  - pattern-not-regex: '(?i)exif_imagetype\s*\('
  - pattern-not-regex: '(?i)wp_handle_upload\s*\('
  # Quarantine suppression now handled via structured pattern-inside blocks
  # Additional safe patterns observed in repo safe examples
  - pattern-not-regex: '(?i)wp_upload_dir\s*\('
  - pattern-not-regex: '(?i)sanitize_file_name\s*\('
  - pattern-not-regex: '(?i)wp_unique_filename\s*\('
  - pattern-not-regex: "(?i)current_user_can\\s*\\(\\s*[\\\"']upload_files[\\\"']\\s*\\)"
  - pattern-not-regex: '(?i)wp_max_upload_size\s*\('

  # Suppress when robust MIME/content checks exist in the same scope before move
  - pattern-not:
      pattern-inside: |
        ...
        $FINFO = finfo_open(...);
        ...
        $MIME = finfo_file(...);
        ...
        move_uploaded_file($TMP, $DEST);

  - pattern-not:
      pattern-inside: |
        ...
        $T = exif_imagetype(...);
        ...
        move_uploaded_file($TMP, $DEST);

  - pattern-not:
      pattern-inside: |
        ...
        $SIZE = getimagesize(...);
        ...
        move_uploaded_file($TMP, $DEST);

  # Suppress when canonical WP upload flow or safeguards are used in the same scope
  - pattern-not:
      pattern-inside: |
        ...
        $UP = wp_upload_dir(...);
        ...
        $SAFE = sanitize_file_name(...);
        ...
        $UNIQ = wp_unique_filename(...);
        ...
        move_uploaded_file($TMP, $DEST);

  - pattern-not:
      pattern-inside: |
        if ( current_user_can('upload_files') ) { ... move_uploaded_file($TMP, $DEST); ... }

  - pattern-not:
      pattern-inside: |
        ...
        if ($F['size'] > wp_max_upload_size()) { ... }
        ...
        move_uploaded_file($TMP, $DEST);

  # Suppress quarantine-first flows (tmp then async scan/rename)
  - pattern-not:
      pattern-inside: |
        ...
        $Q = sys_get_temp_dir() . $ANY;
        ...
        move_uploaded_file($TMP, $Q);

  # Suppress when an explicit scan function gates the move operation
  - pattern-not:
      pattern-inside: |
        ...
        if (!$SCAN($TMP)) { ... }
        ...
        move_uploaded_file($TMP, $DEST);


