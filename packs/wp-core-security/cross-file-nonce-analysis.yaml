rules:
- id: wordpress.cross-file.ajax-nonce-lifecycle
  message: "AJAX action '$ACTION' is registered but the callback function '$CALLBACK'\
    \ \nlacks proper nonce verification. This creates a CSRF vulnerability.\n"
  severity: ERROR
  languages:
  - php
  patterns:

  - pattern: 'add_action("wp_ajax_$ACTION", "$CALLBACK");'
  metadata:
    category: cross-file-analysis
    cwe: CWE-352
    technology:
    - wordpress
    confidence: high
    description: 'This rule detects AJAX action registrations that may lack proper nonce verification.

      It identifies when an AJAX action is registered via add_action(''wp_ajax_*'') which
      could create a Cross-Site Request Forgery (CSRF) vulnerability if not properly secured.

      '
    tags:
    - error
    - nonce
    - authentication
    - wordpress
    - csrf
    - security
    vuln_class: csrf
- id: wordpress.ajax.action-registration
  message: AJAX action registration detected
  severity: INFO
  languages:
  - php
  patterns:

  - pattern: 'add_action(''wp_ajax_$ACTION'', ''$CALLBACK'');

    '
  metadata:
    category: ajax-security
    technology:
    - wordpress
    confidence: high
    cwe: CWE-285
    tags:
    - rest_ajax
    - wordpress
    - ajax
    - endpoints
    - info
    - security
    - rest-api
    vuln_class: rest_ajax
- id: wordpress.ajax.callback-function
  message: AJAX callback function detected
  severity: INFO
  languages:
  - php
  patterns:

  - pattern: "function $FUNCTION_NAME() {\n  ...\n}\n"
  metadata:
    category: ajax-security
    technology:
    - wordpress
    confidence: high
    cwe: CWE-285
    tags:
    - rest_ajax
    - wordpress
    - ajax
    - endpoints
    - info
    - security
    - rest-api
    vuln_class: rest_ajax
- id: wordpress.nonce.verification-in-function
  message: Nonce verification detected in function
  severity: INFO
  languages:
  - php
  patterns:

  - pattern: "function $FUNCTION_NAME() {\n  ...\n  check_ajax_referer('$NONCE_ACTION',\
    \ '$NONCE_FIELD');\n  ...\n}\n"
  metadata:
    category: nonce-verification
    technology:
    - wordpress
    confidence: high
    cwe: CWE-352
    tags:
    - nonce
    - authentication
    - wordpress
    - csrf
    - info
    - security
    vuln_class: csrf
- id: wordpress.nonce.verification-wp-verify
  message: wp_verify_nonce detected in function
  severity: INFO
  languages:
  - php
  patterns:

  - pattern: "function $FUNCTION_NAME() {\n  ...\n  if (wp_verify_nonce($_POST['$NONCE_FIELD'],\
    \ '$NONCE_ACTION')) {\n    ...\n  }\n  ...\n}\n"
  metadata:
    category: nonce-verification
    technology:
    - wordpress
    confidence: high
    cwe: CWE-352
    tags:
    - nonce
    - authentication
    - wordpress
    - csrf
    - info
    - security
    vuln_class: csrf
- id: wordpress.cross-file.nonce-creation-verification
  message: 'Nonce created with action ''$CREATE_ACTION'' but verified with different
    action ''$VERIFY_ACTION''.

    This creates a security vulnerability as the nonce verification will fail.

    '
  severity: ERROR
  languages:
  - php
  patterns:

  - pattern: 'wp_create_nonce($CREATE_ACTION)'
  metadata:
    category: cross-file-analysis
    cwe: CWE-352
    technology:
    - wordpress
    confidence: high
    description: 'This rule detects when a nonce is created with one action name but
      verified with a different

      action name, which will cause the verification to fail and potentially create
      security issues.

      '
    tags:
    - error
    - nonce
    - authentication
    - wordpress
    - csrf
    - security
    vuln_class: csrf
- id: wordpress.nonce.creation-detection
  message: Nonce creation detected
  severity: INFO
  languages:
  - php
  patterns:

  - pattern: 'wp_create_nonce(''$CREATE_ACTION'')

    '
  metadata:
    category: nonce-verification
    technology:
    - wordpress
    confidence: high
    cwe: CWE-352
    tags:
    - nonce
    - authentication
    - wordpress
    - csrf
    - info
    - security
    vuln_class: csrf
- id: wordpress.nonce.verification-action-detection
  message: Nonce verification with action detected
  severity: INFO
  languages:
  - php
  patterns:

  - pattern: 'check_ajax_referer(''$VERIFY_ACTION'', ''$NONCE_FIELD'')

    '
  metadata:
    category: nonce-verification
    technology:
    - wordpress
    confidence: high
    cwe: CWE-352
    tags:
    - nonce
    - authentication
    - wordpress
    - csrf
    - info
    - security
    vuln_class: csrf
- id: wordpress.nonce.verification-wp-verify-action
  message: wp_verify_nonce with action detected
  severity: INFO
  languages:
  - php
  patterns:

  - pattern: 'wp_verify_nonce($_POST[''$NONCE_FIELD''], ''$VERIFY_ACTION'')

    '
  metadata:
    category: nonce-verification
    technology:
    - wordpress
    confidence: high
    cwe: CWE-352
    tags:
    - nonce
    - authentication
    - wordpress
    - csrf
    - info
    - security
    vuln_class: csrf
