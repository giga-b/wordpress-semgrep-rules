rules:
  # Warn when wp_handle_upload is used without any prior file type validation in the same function
  - id: wordpress.file.upload.missing-type-allowlist
    languages: [php]
    message: wp_handle_upload used without explicit type allowlist (wp_check_filetype[_and_ext])
    severity: WARNING
    metadata:
      category: file-operations
      cwe: CWE-434
      vuln_class: file_upload
      confidence: high
    patterns:
      - pattern-inside: |
          function $HANDLER(...) {
            ...
          }
      - pattern: |
          $UPLOAD = wp_handle_upload($FILE, ...)
      # Exempt if function contains any type check helpers
      - pattern-not-inside: |
          function $HANDLER(...) {
            ...
            wp_check_filetype_and_ext(...);
            ...
          }
      - pattern-not-inside: |
          function $HANDLER(...) {
            ...
            wp_check_filetype(...);
            ...
          }
      # Exempt if upload is directly guarded by an allowlist block
      - pattern-not-inside: |
          if (in_array($TYPE['ext'], $ALLOWED, true)) {
            ...
            $UPLOAD = wp_handle_upload(...);
            ...
          }
      # Exempt if function uses negative allowlist guard (early return) anywhere
      - pattern-not-inside: |
          function $HANDLER(...) {
            ...
            if (!in_array(...)) {
              ...
            }
            ...
          }

  # Error when move_uploaded_file to unsanitized/unsafe destination
  - id: wordpress.file.upload.unsafe-move-no-sanitize
    languages: [php]
    message: move_uploaded_file to destination without sanitize_file_name or wp_unique_filename
    severity: ERROR
    metadata:
      category: file-operations
      cwe: CWE-434
      vuln_class: file_upload
      confidence: high
    patterns:
      - pattern: |
          move_uploaded_file($_FILES[...]['tmp_name'], $DEST)
      - pattern-not: |
          move_uploaded_file($_FILES[...]['tmp_name'], sanitize_file_name(...))
      - pattern-not: |
          move_uploaded_file($_FILES[...]['tmp_name'], $DIR . '/' . sanitize_file_name(...))
      - pattern-not: |
          move_uploaded_file($_FILES[...]['tmp_name'], wp_unique_filename($UPLOADS['path'], ...))
      - pattern-not: |
          move_uploaded_file($_FILES[...]['tmp_name'], $UPLOADS['path'] . '/' . wp_unique_filename($UPLOADS['path'], ...))


